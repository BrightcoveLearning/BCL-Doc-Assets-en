<link href="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/js/pikaday/pikaday.css" rel="stylesheet" />
<article class="bcls-article">
<section class="bcls-section">
<h2 id="dependencies">Dependencies</h2>

<p>3rd party libraries used in this sample:</p>

<p><a href="https://github.com/dbushell/Pikaday">Pikaday</a></p>
</section>

<section class="bcls-section">
<h2 id="gettingCredentials" class="bcls-expander-head">Getting Credentials</h2>

<div class="bcls-expander-content">
<p>To get a <code>client_id</code> and <code>client_secret</code>, you will need to go to the OAuth UI and register this app:</p>

<ul>
	<li><a href="/node/14056">Managing API Authentication Credentials</a></li>
</ul>

<p>These are the permissions you will need:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="Analytics API Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/aapi-permissions.png" />
<figcaption class="bcls-caption--image">Analytics API Permissions</figcaption>
</figure>

<p>You can also get your credentials via CURL or Postman - see:</p>

<ul>
	<li><a href="/node/17924">Get Client Credentials Using CURL</a></li>
	<li><a href="/node/17923">Get Client Credentials Using Postman</a></li>
</ul>

<p>If you are getting credentials directly from the API, these are the permissions you need:</p>

<pre class="line-numbers">
<code class="language-json">[
  "video-cloud/analytics/read",
  "video-cloud/video/read"
]</code></pre>
</div>
</section>

<section class="bcls-section">
<h2 id="inputs">Inputs</h2>

<fieldset class="bcls-fieldset"><legend>Basic Information</legend>

<p>By default, you will get results from the Brightcove Training Videos account.</p>

<p><span class="bcls-button" id="useMyAccount">Use My Account Instead</span></p>

<div id="basicInfo" style="display:none">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>Video Cloud Account (Publisher ID):</td>
			<td><input id="accountID" class="required aapi-request" type="text" size="55" /></td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client id:</td>
			<td><input id="client_id" class="required aapi-request" type="text" size="100" value="" />
			<p>&nbsp;</p>
			</td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client secret:</td>
			<td><input id="client_secret" class="required aapi-request" type="text" size="100" value="" />
			<p>&nbsp;</p>
			</td>
		</tr>
	</tbody>
</table>

<p class="small" id="n1"><sup class="red">[1]</sup> See <a href="/node/14056">Managing API Credentials</a> for information on getting client credentials.</p>
</div>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Report Options</legend>

<h4>Date Range</h4>

<p>Start: <input id="fromDatePicker" size="30" placeholder="2016-01-01" /> (default: 30 days ago)</p>

<p>End: &nbsp;<input id="toDatePicker" size="30" placeholder="2016-01-31" /> (default: today)</p>

<p><span class="bcls-button" id="getData">Get Data for the Account</span></p>

<h3>Video Options</h3>

<p>To get results for a specific video, make a selection below</p>

<p><select id="videoSelector"></select></p>

<p class="text-warning" id="gettingDataDisplay">&nbsp;</p>
</fieldset>
</section>

<section class="bcls-section">
<h2 id="aapiRequest">Analytics API Request</h2>
<textarea id="requestURL" rows="3" cols="200">API request will appear here...</textarea></section>

<section class="bcls-section" id="results">
<h2>Geo Analytics Report</h2>

<div id="video_info">&nbsp;</div>

<table class="bcls-table">
	<thead class="bcls-table__head">
		<tr>
			<th>Country</th>
			<th>Video Views</th>
			<th>Average Viewed Seconds</th>
		</tr>
	</thead>
	<tbody id="reportTableBody">
	</tbody>
</table>
</section>

<div class="bcls-section">
<h2 id="code">Code for the sample</h2>

<h3>HTML</h3>

<p>View the page source to see the HTML code.</p>

<h3>JavaScript</h3>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = (function (window, document, Pikaday) {
    'use strict';
    var proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/geo-report-proxy.php',
        useMyAccount = document.getElementById('useMyAccount'),
        basicInfo = document.getElementById('basicInfo'),
        $accountID = document.getElementById('accountID'),
        account_id = '1752604059001',
        $client_id = document.getElementById('client_id'),
        $client_secret = document.getElementById('client_secret'),
        client_id = '',
        client_secret = '',
        $videoSelector = document.getElementById('videoSelector'),
        $reportTableBody = document.getElementById('reportTableBody'),
        fromDatePicker = document.getElementById('fromDatePicker'),
        toDatePicker = document.getElementById('toDatePicker'),
        $getData = document.getElementById('getData'),
        $gettingDataDisplay = document.getElementById('gettingDataDisplay'),
        video_info = document.getElementById('video_info'),
        $requestURL = document.getElementById('requestURL'),
        currentVideo,
        currentVideoObj,
        analyticsData = {},
        chartData = [],
        callType,
        fromPicker,
        toPicker,
        now = new Date(),
        nowMS = now.valueOf(),
        then = new Date(nowMS - (1000 * 60 * 60 * 24 * 30)), // 30 days ago in milliseconds
        nowISO = now.toISOString().substr(0, 10), // get the date part of the date-time string
        thenISO = then.toISOString().substr(0, 10); // get the date part of the date-time string
        /**
         * Logging function - safe for IE
         * @param  {string} context description of the data
         * @param  {*} message the data to be logged by the console
         * @return {}
         */
        function bclslog(context, message) {
            if (window['console'] &amp;&amp; console['log']) {
              console.log(context, message);
            }
            return;
        }

        // more robust test for strings 'not defined'
        /**
         * tests for all the ways a variable might be undefined or not have a value
         * @param {*} x the variable to test
         * @return {Boolean} true if variable is defined and has a value
         */
        function isDefined(x) {
            if ( x === '' || x === null || x === undefined || x === NaN) {
                return false;
            }
            return true;
        }

        /**
         * get selected value for single select element
         * @param {htmlElement} e the select element
         * @return {Object} object containing the `value` and selected `index`, and the option text
         */
        function getSelectedValue(e) {
            var val = e.options[e.selectedIndex].value,
                txt = e.options[e.selectedIndex].textContent,
                idx = e.selectedIndex;
            return {
                value: val,
                text: txt,
                index: idx
            };
        }

        /**
         * builds the data display
         * @param {Object[]} array of analytics items
         */
        function displayData(items) {
            var newTr,
                newTd,
                txt,
                results = new DocumentFragment();
            // display the video info
            video_info.textContent = 'Video: ' + currentVideoObj.text + ' (' + currentVideoObj.value + ')';
            items.forEach(function(item, index, items) {
                newTr = document.createElement('tr');
                newTd = document.createElement('td');
                txt = document.createTextNode(item.country_name);
                newTd.appendChild(txt);
                newTr.appendChild(newTd);
                newTd = document.createElement('td');
                txt = document.createTextNode(item.video_view);
                newTd.appendChild(txt);
                newTr.appendChild(newTd);
                newTd = document.createElement('td');
                txt = document.createTextNode(item.video_seconds_viewed);
                newTd.appendChild(txt);
                newTr.appendChild(newTd);
                results.appendChild(newTr);
            });
            $reportTableBody.appendChild(results);
        }

        /**
         * Builds the API requests and handles responses
         * @param {String} type the request type (getCount | getVideos | getAnalytics)
         */
        function buildRequest(type) {
            var requestOptions = {},
                tmpArray,
                newVideoItem = {},
                videoItem,
                newEl,
                txt,
                i,
                iMax,
                item,
                fields,
                frag = new DocumentFragment();
            // add credentials if submitted
            if (isDefined(client_id) &amp;&amp; isDefined(client_secret)) {
                requestOptions.client_id = client_id;
                requestOptions.client_secret = client_secret;
            }
            switch (type) {
                case 'getVideos':
                requestOptions.url = 'https://analytics.api.brightcove.com/v1/data?accounts=' + account_id + '&amp;dimensions=video&amp;limit=all&amp;fields=video,video.name&amp;sort=-video_view&amp;from=' + fromDatePicker.value + '&amp;to=' + toDatePicker.value;
                $requestURL.textContent = requestOptions.url;
                getData(requestOptions, type, function(response) {
                    // create the video selector items from the response items
                    newEl = document.createElement('option');
                    newEl.setAttribute('value', '');
                    txt = document.createTextNode('Select a video');
                    newEl.appendChild(txt);
                    frag.appendChild(newEl);
                    iMax = response.items.length;
                    for (i = 0; i &lt; iMax; i++) {
                        item = response.items[i];
                        newEl = document.createElement('option');
                        newEl.setAttribute('value', item.video);
                        txt = document.createTextNode(item['video.name']);
                        newEl.appendChild(txt);
                        frag.appendChild(newEl);
                    }
                    // append the options to the video selector
                    $videoSelector.appendChild(frag);
                });
                    break;
                case 'getAnalytics':
                    currentVideo = currentVideoObj.value;
                    // fields to return
                    fields = 'country,country_name,video_view,video_seconds_viewed';
                    requestOptions.url = 'https://analytics.api.brightcove.com/v1/data?accounts=' + account_id + '&amp;dimensions=country&amp;limit=all&amp;fields=' + fields + '&amp;from=' + fromDatePicker.value + '&amp;to=' + toDatePicker.value + '&amp;where=video==' + currentVideo;
                    $requestURL.textContent = requestOptions.url;
                    getData(requestOptions, type, function(response) {
                        // display the data
                        displayData(response.items);
                    });
                    break;
            }
        }

        /**
         * send API request to the proxy
         * @param  {Object} requestData options for the request
         * @param  {String} requestID the type of request
         * @param  {Function} callback the callback function to invoke
         */
        function getData(options, type, callback) {
            var httpRequest = new XMLHttpRequest(),
                parsedData,
                requestParams,
                dataString,
                // response handler
                getResponse = function() {
                    try {
                      if (httpRequest.readyState === 4) {
                        if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                          parsedData = JSON.parse(httpRequest.responseText);
                          callback(parsedData);
                        } else {
                          alert('There was a problem with the request. Request returned ' + httpRequest.status);
                        }
                      }
                    } catch (e) {
                      alert('Caught Exception: ' + e);
                    }
                };
                // set up request data
            requestParams = 'url=' + encodeURIComponent(options.url) + '&amp;requestType=GET';
            if (options.client_id &amp;&amp; options.client_secret) {
                requestParams += '&amp;client_id=' + options.client_id + '&amp;client_secret=' + options.client_secret;
            }

            // set response handler
            httpRequest.onreadystatechange = getResponse;
            // open the request
            httpRequest.open('POST', proxyURL);
            // set headers
            httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            // open and send request
            httpRequest.send(requestParams);
        }


    // add date pickers to the date input fields
    fromPicker = new Pikaday({
      field: fromDatePicker,
      format: 'YYYY-MM-DD'
    });
    toPicker = new Pikaday({
      field: toDatePicker,
      format: 'YYYY-MM-DD'
    });
    // set initial from/to values
    fromDatePicker.value = thenISO;
    toDatePicker.value = nowISO;

    // set event listeners
    useMyAccount.addEventListener('click', function () {
        if (basicInfo.getAttribute('style') === 'display:none') {
            basicInfo.setAttribute('style', 'display:block');
            useMyAccount.textContent = 'Use Sample Account';
        } else {
            basicInfo.setAttribute('style', 'display:none');
            useMyAccount.textContent = 'Use My Account Instead';
        }

    });
    $videoSelector.addEventListener('change', function () {
        // get video and geo selections
        currentVideoObj = getSelectedValue($videoSelector);
        buildRequest('getAnalytics');
    });
    $getData.addEventListener('click', function() {
        account_id = (isDefined($accountID.value)) ? $accountID.value : account_id;
        $gettingDataDisplay.textContent = 'Getting video data...';
        buildRequest('getVideos');
    });

    return {};
})(window, document, Pikaday);</code></pre>

<h3>Proxy</h3>

<p>This app uses a proxy written in PHP to fetch access tokens and make the Analytics API requests.</p>

<aside class="bcls-aside bcls-aside--information">In order to build your own version the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.) You can download two versions of our proxy code:
<ul>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/bcls-proxy-for-distribution.php.zip">This is a general version that expects client credentials to be passed with the request</a></li>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/doc-samples-proxy.php.zip">This version allows you to save your client credentials in the proxy itself on lines 25-26 (recommended)</a></li>
</ul>
</aside>
</div>
</article>
<!-- chart.js charting package --><!-- for date picker --><script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script><script src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/js/pikaday/pikaday.min.js"></script><script id="pageScript" type="text/javascript" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/code-samples/geo-report/geo-report.js"></script>
