<link href="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/js/pikaday/pikaday.css" rel="stylesheet" />
<article class="bcls-article">
<section class="bcls-section">
<h2 id="dependencies">Dependencies</h2>

<p>3rd party libraries used in this sample:</p>

<p><a href="https://github.com/dbushell/Pikaday">Pikaday</a></p>
</section>

<section class="bcls-section">
<h2 id="gettingCredentials" class="bcls-expander-head">Getting Credentials</h2>

<div class="bcls-expander-content">
<p>To get a <code>client_id</code> and <code>client_secret</code>, you will need to go to the OAuth UI and register this app:</p>

<ul>
	<li><a href="/node/14056">Managing API Authentication Credentials</a></li>
</ul>

<p>These are the permissions you will need:</p>

<figure class="bcls-figure"><img class="bcls-image" alt="Analytics API Permissions" src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/aapi-permissions.png" />
<figcaption class="bcls-caption--image">Analytics API Permissions</figcaption>
</figure>

<p>You can also get your credentials via CURL or Postman - see:</p>

<ul>
	<li><a href="/node/17924">Get Client Credentials Using CURL</a></li>
	<li><a href="/node/17923">Get Client Credentials Using Postman</a></li>
</ul>

<p>If you are getting credentials directly from the API, these are the permissions you need:</p>

<pre class="line-numbers">
<code class="language-json">[
  "video-cloud/analytics/read",
  "video-cloud/video/read"
]</code></pre>
</div>
</section>

<section class="bcls-section">
<h2 id="Request_Options">Request Options</h2>

<p>Where no default value is indicated, there is none.</p>

<div id="inputFields" class="input-fields">
<fieldset class="bcls-fieldset"><legend>Basic Information</legend>

<p>By default, you will get results from the Brightcove Training Videos account.</p>

<p><span class="bcls-button" id="useMyAccount">Use My Account Instead</span></p>

<div id="basicInfo" style="display:none;">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>Video Cloud Account (Publisher ID):</td>
			<td><input id="accountID" class="aapi-request" type="text" size="55" /></td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client id:</td>
			<td><input id="client_id" class="aapi-request" type="text" size="100" value="" />
			<p>&nbsp;</p>
			</td>
		</tr>
		<tr>
			<td class="align-top no-wrap">Client secret:</td>
			<td><input id="client_secret" class="aapi-request" type="text" size="100" value="" />
			<p>&nbsp;</p>
			</td>
		</tr>
	</tbody>
</table>

<p class="small" id="n1"><sup class="red">[1]</sup> See <a href="/node/14056">Managing API Authentication Credentials</a> for information on getting client credentials.</p>
</div>
</fieldset>

<fieldset class="bcls-fieldset"><legend>Filters</legend>

<div id="filters">
<table class="bcls-table">
	<tbody class="bcls-table__body">
		<tr>
			<td>From:</td>
			<td>Date: <input class="date-range" id="from" type="text" size="30" /> (default: 30 days ago -- choose the same date for From and To to get a report for that day)</td>
		</tr>
		<tr>
			<td>To:</td>
			<td>Date: <input class="date-range" id="to" type="text" size="30" /> (default: now)</td>
		</tr>
		<tr>
			<td>Tags (add one or more tags separated by commas - default: <code>bird,budapest</code>):</td>
			<td><input class="aapi-request" id="tags" type="text" size="70" /></td>
		</tr>
	</tbody>
</table>
</div>
</fieldset>
</div>
</section>

<section class="bcls-section">
<h2 id="API_Request">API Request</h2>

<div id="requestSubmitter">
<p>API Request</p>
<textarea id="request" name="request" class="bcls-code">API request will appear here...</textarea>

<p><button class="bcls-button" id="submitButton">Get Analytics Data</button></p>
</div>
</section>

<section class="bcls-section">
<h2 id="Response">Response</h2>

<p><button class="bcls-button" id="selectData">Select the Data to Copy</button></p>
<textarea class="bcls-code" id="responseFrame" style="height:12em;">Response will appear here...</textarea></section>

<section class="bcls-section">
<h2 id="jscode">JavaScript Code</h2>

<p>JavaScript code for this sample:</p>

<pre class="line-numbers">
<code class="language-javascript">var BCLS = (function(window, document, Pikaday) {
  'use strict';
  var proxyURL = 'https://solutions.brightcove.com/bcls/bcls-proxy/analytics-by-tag.php',
    basicInfo = document.getElementById('basicInfo'),
    useMyAccount = document.getElementById('useMyAccount'),
    $accountID = document.getElementById('accountID'),
    accountID = '1752604059001',
    $client_id = document.getElementById('client_id'),
    client_id = null,
    $client_secret = document.getElementById('client_secret'),
    client_secret = null,
    $requestType = document.getElementById('requestType'),
    fromPicker,
    toPicker,
    to = document.getElementById('to'),
    from = document.getElementById('from'),
    now = new Date(),
    nowMS = now.valueOf(),
    fromMS = nowMS - (30 * 24 * 60 * 60 * 1000),
    fromDate = new Date(fromMS),
    nowISO = now.toISOString(),
    fromISO = fromDate.toISOString(),
    $tags = document.getElementById('tags'),
    tags = 'bird,budapest',
    $request = document.getElementById('request'),
    $submitButton = document.getElementById('submitButton'),
    $selectData = document.getElementById('selectData'),
    $requestInputs = document.getElementsByClassName('aapi-request'),
    $responseFrame = document.getElementById('responseFrame'),
    requestURL = '',
    endDate = '',
    startDate = '',
    requestOptions = {},
    i,
    iMax;

  /**
   * Logging function - safe for IE
   * @param  {string} context description of the data
   * @param  {*} message the data to be logged by the console
   * @return {}
   */
  function bclslog(context, message) {
    if (window['console'] &amp;&amp; console['log']) {
      console.log(context, message);
    }
    ;
    return;
  }

  // more robust test for strings 'not defined'
  function isDefined(v) {
    if (v === '' || v === null || v === undefined || v === NaN) {
      return false;
    }
    return true;
  }

  // remove space after comma and URI encode
  function removeSpaces(str) {
    if (isDefined(str)) {
      str = str.replace(', ', ',');
      str = encodeURI(str);
      return str;
    }
  }

  // construct the request
  function buildRequest() {
    var account_id = (isDefined($accountID.value)) ? $accountID.value : accountID;
    tags = (isDefined($tags.value)) ? $tags.value : tags;
    // add client credentials if any
    if (isDefined($client_id.value)) {
        requestOptions.client_id = $client_id.value;
    }
    if (isDefined($client_secret.value)) {
        requestOptions.client_secret = $client_secret.value;
    }

    // build the request
    requestOptions.url = 'https://analytics.api.brightcove.com/v1';
    requestOptions.url += '/data?accounts=' + account_id + '&amp;dimensions=video';
    // check for time filters
    startDate = from.value || fromISO;
      // startDate = fromPicker.toString('YYYY-MM-DD');
      requestOptions.url += '&amp;from=' + startDate;
    endDate = to.value || nowISO;
      // endDate = toPicker.toString('YYYY-MM-DD');
      requestOptions.url += '&amp;to=' + endDate;

    // add limit and fields
    requestOptions.url += '&amp;limit=all&amp;fields=engagement_score,play_rate,video,video_duration,video_engagement_1,video_engagement_100,video_engagement_25,video_engagement_50,video_engagement_75,video_impression,video_name,video_percent_viewed,video_seconds_viewed,video_view,video.tags';
    // add ref id filter
    requestOptions.url += '&amp;where=video.q==tags:' + removeSpaces(tags);
    $request.textContent = requestOptions.url;
    $request.setAttribute('value', requestOptions.url);
  }

  /**
   * send API request to the proxy
   * @param  {Object} requestData options for the request
   * @param  {Function} callback the callback function to invoke
   */
  function getData(options, callback) {
      var httpRequest = new XMLHttpRequest(),
          parsedData,
          requestParams,
          dataString,
          // response handler
          getResponse = function() {
              try {
                if (httpRequest.readyState === 4) {
                  if (httpRequest.status &gt;= 200 &amp;&amp; httpRequest.status &lt; 300) {
                    parsedData = JSON.parse(httpRequest.responseText);
                    callback(parsedData);
                  } else {
                    alert('There was a problem with the request. Request returned ' + httpRequest.status);
                  }
                }
              } catch (e) {
                alert('Caught Exception: ' + e);
              }
          };
          // set up request data
      requestParams = 'url=' + encodeURIComponent(options.url) + '&amp;requestType=GET';
      if (options.client_id &amp;&amp; options.client_secret) {
          requestParams += '&amp;client_id=' + options.client_id + '&amp;client_secret=' + options.client_secret;
      }

      // set response handler
      httpRequest.onreadystatechange = getResponse;
      // open the request
      httpRequest.open('POST', proxyURL);
      // set headers
      httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      // open and send request
      httpRequest.send(requestParams);
  }

  // add date pickers to the date input fields
  fromPicker = new Pikaday({
    field: from,
    format: 'YYYY-MM-DD',
    onSelect: buildRequest
  });
  toPicker = new Pikaday({
    field: to,
    format: 'YYYY-MM-DD',
    onSelect: buildRequest
  });
  // populate to/from fields with default values
  nowISO = nowISO.substring(0, nowISO.indexOf('T'));
  fromISO = fromISO.substring(0, fromISO.indexOf('T'));
  to.value = nowISO;
  from.value = fromISO;

  // set event listeners
  useMyAccount.addEventListener('click', function () {
      if (basicInfo.getAttribute('style') === 'display:none;') {
          basicInfo.setAttribute('style', 'display:block;');
          useMyAccount.innerHTML = 'Use Sample Account';
      } else {
          basicInfo.setAttribute('style', 'display:none;');
          useMyAccount.textContent = 'Use My Account Instead';
      }
  });


  // set listener for form fields
  iMax = $requestInputs.length;
  for (i = 0; i &lt; iMax; i++) {
      $requestInputs[i].addEventListener('change', buildRequest);
  }
  // send request
  $submitButton.addEventListener('click', function(){
      getData(requestOptions, function(response) {
          bclslog('response', response);
          responseFrame.textContent = JSON.stringify(response, null, '  ');
      });
  });
  // select all the data
  $selectData.addEventListener('click', function() {
    document.getElementById('responseFrame').select();
  });
  // generate initial request
  buildRequest();
})(window, document, Pikaday);</code></pre>

<h3>Proxy</h3>

<aside class="bcls-aside bcls-aside--information">In order to build your own version of the sample app on this page, you must create and host your own proxy. (The proxies used by Brightcove Learning Services only accept requests from Brightcove domains.) You can download two versions of our proxy code:
<ul>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/bcls-proxy-for-distribution.php.zip">This is a general version that expects client credentials to be passed with the request</a></li>
	<li><a href="//learning-services-media.brightcove.com/doc-assets/proxy/doc-samples-proxy.php.zip">This version allows you to save your client credentials in the proxy itself on lines 25-26 (recommended)</a></li>
</ul>
</aside>
</section>
</article>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js"></script><script src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/js/pikaday/pikaday.min.js"></script><!-- <script src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/js/bc-mapi.js"></script> --><script src="//learning-services-media.brightcove.com/doc-assets/video-cloud-apis/analytics-api/code-samples/analytics-by-tag/analytics-by-tag.js"></script>
